<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Prediction Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!-- Chart.js CDN for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Alpha Vantage API: Replace with your actual API key -->
    <script>
        const API_KEY = 'demo'; // Use 'demo' for testing; replace with real key from https://www.alphavantage.co/support/#api-key
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col items-center justify-center p-4">
    <!-- Hero Section -->
    <header class="w-full max-w-4xl text-center mb-8">
        <h1 class="text-3xl font-bold mb-2">Stock Prediction Dashboard</h1>
        <p class="text-lg text-gray-600 dark:text-gray-400">Search companies, classify success, and predict future prices.</p>
    </header>

    <!-- Search Bar -->
    <div class="w-full max-w-4xl mb-8">
        <input type="text" id="searchInput" placeholder="Search for a company (e.g., AAPL)" class="w-full p-4 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300" aria-label="Search for a company">
        <div id="suggestions" class="mt-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"></div>
    </div>

    <!-- Results Section -->
    <div id="results" class="w-full max-w-4xl hidden">
        <!-- Classification Card -->
        <div id="classificationCard" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8 transition duration-500 transform">
            <h2 class="text-2xl font-semibold mb-4">Classification Result</h2>
            <p id="classificationResult" class="text-lg"></p>
            <div id="detailsAccordion" class="mt-4"></div>
        </div>

        <!-- Prediction Section (Shown only if successful) -->
        <div id="predictionSection" class="hidden">
            <!-- Date Range Picker -->
            <div class="mb-8">
                <label class="block text-lg font-medium mb-2">Select Prediction Range</label>
                <div class="flex space-x-4">
                    <input type="date" id="startDate" class="p-2 border rounded-lg dark:bg-gray-800">
                    <input type="date" id="endDate" class="p-2 border rounded-lg dark:bg-gray-800">
                    <button id="updatePrediction" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">Update</button>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-xl font-semibold mb-2">Historical Prices</h3>
                    <canvas id="historicalChart"></canvas>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2">Predicted Prices</h3>
                    <canvas id="predictionChart"></canvas>
                </div>
            </div>

            <!-- Predicted Values Table -->
            <div class="mt-8">
                <h3 class="text-xl font-semibold mb-2">Predicted Values</h3>
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-200 dark:bg-gray-700">
                            <th class="p-2">Date</th>
                            <th class="p-2">Predicted Price</th>
                        </tr>
                    </thead>
                    <tbody id="predictionTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-500"></div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // Utility Functions
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function debounce(func, delay) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), delay);
            };
        }

        // Search Functionality
        const searchInput = document.getElementById('searchInput');
        const suggestions = document.getElementById('suggestions');

        searchInput.addEventListener('input', debounce(async () => {
            const query = searchInput.value.trim();
            if (query.length < 2) {
                suggestions.classList.add('hidden');
                return;
            }
            showLoading(true);
            try {
                const response = await fetch(`https://www.alphavantage.co/query?function=SYMBOL_SEARCH&keywords=${query}&apikey=${API_KEY}`);
                const data = await response.json();
                suggestions.innerHTML = '';
                if (data.bestMatches) {
                    data.bestMatches.forEach(match => {
                        const div = document.createElement('div');
                        div.classList.add('p-2', 'hover:bg-gray-100', 'dark:hover:bg-gray-700', 'cursor-pointer', 'transition');
                        div.textContent = `${match['1. symbol']} - ${match['2. name']}`;
                        div.addEventListener('click', () => selectCompany(match['1. symbol']));
                        suggestions.appendChild(div);
                    });
                    suggestions.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error fetching suggestions:', error);
            }
            showLoading(false);
        }, 300));

        // Select Company and Analyze
        async function selectCompany(symbol) {
            suggestions.classList.add('hidden');
            showLoading(true);
            document.getElementById('results').classList.remove('hidden');
            try {
                const response = await fetch(`https://www.alphavantage.co/query?function=TIME_SERIES_MONTHLY_ADJUSTED&symbol=${symbol}&apikey=${API_KEY}`);
                const data = await response.json();
                const timeSeries = data['Monthly Adjusted Time Series'];
                if (!timeSeries) throw new Error('No data available');

                // Extract past prices (last 10 years, approx 120 months)
                const dates = Object.keys(timeSeries).slice(0, 120).reverse();
                const prices = dates.map(date => parseFloat(timeSeries[date]['5. adjusted close']));

                // Run Classification Formula (Simplified Logistic Regression in JS)
                const classification = classifyStock(prices);
                displayClassification(classification, symbol);

                if (classification.label === 1) {
                    // Run Prediction if successful
                    const predictions = predictPrices(prices, 60); // Predict next 60 months
                    displayPredictions(dates, prices, predictions);
                }
            } catch (error) {
                alert('Error fetching data: ' + error.message);
            }
            showLoading(false);
        }

        // Classification Formula (Simplified for JS - Using thresholds as proxy for logistic)
        function classifyStock(prices) {
            const n = prices.length;
            const returns = [];
            for (let i = 1; i < n; i++) {
                returns.push((prices[i] - prices[i-1]) / prices[i-1]);
            }
            const meanReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
            const volatility = Math.sqrt(returns.reduce((a, b) => a + Math.pow(b - meanReturn, 2), 0) / (returns.length - 1));
            const cagr = Math.pow(prices[n-1] / prices[0], 1 / (n / 12)) - 1; // Assuming monthly
            const sharpe = (meanReturn - 0.03 / 12) / volatility; // Monthly risk-free 0.03/12

            const probability = 1 / (1 + Math.exp(- ( -1.2 + 3.5 * cagr + 2.0 * sharpe ))); // Simplified logistic coeffs
            return { label: probability > 0.5 ? 1 : 0, probability: probability.toFixed(2), cagr: cagr.toFixed(2), sharpe: sharpe.toFixed(2) };
        }

        // Display Classification
        function displayClassification(classification, symbol) {
            const resultElem = document.getElementById('classificationResult');
            const color = classification.label === 1 ? 'text-green-500' : 'text-red-500';
            resultElem.innerHTML = `The stock ${symbol} is classified as <span class="${color} font-bold">${classification.label === 1 ? 'Successful' : 'Unsuccessful'}</span> (Probability: ${classification.probability}).`;
            
            const accordion = document.getElementById('detailsAccordion');
            accordion.innerHTML = `<details class="cursor-pointer"><summary>Details</summary><p>CAGR: ${classification.cagr}, Sharpe: ${classification.sharpe}</p></details>`;

            document.getElementById('predictionSection').classList.toggle('hidden', classification.label !== 1);
            document.getElementById('classificationCard').classList.add('scale-100'); // Animation trigger
        }

        // Prediction Formula (Simplified Linear Regression for JS - For real use, implement ARIMA via library)
        function predictPrices(prices, k) {
            const n = prices.length;
            const X = Array.from({length: n}, (_, i) => i + 1);
            const sumX = X.reduce((a, b) => a + b, 0);
            const sumY = prices.reduce((a, b) => a + b, 0);
            const sumXY = X.reduce((a, b, i) => a + b * prices[i], 0);
            const sumX2 = X.reduce((a, b) => a + b * b, 0);
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            const predictions = [];
            for (let j = 1; j <= k; j++) {
                predictions.push(intercept + slope * (n + j));
            }
            return predictions;
        }

        // Display Predictions with Charts
        let historicalChart, predictionChart;
        function displayPredictions(dates, prices, predictions) {
            const futureDates = Array.from({length: predictions.length}, (_, i) => {
                const lastDate = new Date(dates[dates.length - 1]);
                lastDate.setMonth(lastDate.getMonth() + i + 1);
                return lastDate.toISOString().slice(0, 7);
            });

            // Historical Chart
            if (historicalChart) historicalChart.destroy();
            historicalChart = new Chart(document.getElementById('historicalChart'), {
                type: 'line',
                data: { labels: dates, datasets: [{ label: 'Historical Prices', data: prices, borderColor: '#3B82F6' }] },
                options: { animation: { duration: 1000 }, scales: { y: { beginAtZero: false } } }
            });

            // Prediction Chart
            if (predictionChart) predictionChart.destroy();
            predictionChart = new Chart(document.getElementById('predictionChart'), {
                type: 'line',
                data: { labels: futureDates, datasets: [{ label: 'Predicted Prices', data: predictions, borderColor: '#8B5CF6', borderDash: [5, 5] }] },
                options: { animation: { duration: 1000 }, scales: { y: { beginAtZero: false } } }
            });

            // Table
            const tableBody = document.getElementById('predictionTable');
            tableBody.innerHTML = '';
            predictions.forEach((price, i) => {
                const row = `<tr><td class="p-2">${futureDates[i]}</td><td class="p-2">$${price.toFixed(2)}</td></tr>`;
                tableBody.innerHTML += row;
            });
        }

        // Date Range Update (Stub - Would refetch/adjust data)
        document.getElementById('updatePrediction').addEventListener('click', () => {
            alert('Updating predictions for selected range... (Stub functionality)');
        });

        // Dark Mode Toggle (Optional)
        document.body.classList.add('dark'); // Default dark mode, toggle as needed
    </script>
</body>
</html>
